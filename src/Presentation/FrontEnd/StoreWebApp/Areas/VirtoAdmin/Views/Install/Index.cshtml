@using VirtoCommerce.Web
@using VirtoCommerce.Web.Areas.VirtoAdmin.Models
@using Resource = VirtoCommerce.Web.Areas.VirtoAdmin.Resources.Resource;
@model InstallModel
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@Resource.InstallPageTitle</title>
    <link href="~/Areas/VirtoAdmin/Content/site.css" rel="stylesheet" type="text/css" media="all" />
    @Styles.Render(BundleConfig.VirtoAdminStyles)
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/admin")

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script type="text/javascript">
        $(function() {
            // Declare a proxy to reference the hub. 
            var setup = $.connection.setupWorker;

            // Create a function that the hub can call to broadcast messages.
            setup.client.traceMessage = function(message) {
                $('#setUpHeader').text(message);
                $(".console").append(message);
            };
            
            setup.client.traceMessage = function (message)
            {
                $('#setUpHeader').text(message);
                $(".console").append("<br/>");
                $(".console").append(message);
            };

            setup.client.otherMessage = function(message, selector) {
                $(selector).append("<p>" + message + "</p>");
                $(selector).show();
            };

            // Start the connection.
            $.connection.hub.start().done(function() {
                //Make submit in ajax
                $('form').submit(function() {
                    var validator = $(this).validate();
                    if (validator.valid()) {

                        $("#throbber").show();
                        $(".console").show();
                        $(".console").empty();
                        $(".validation-summary-errors").empty();
                        $.ajax({
                            url: this.action,
                            type: this.method,
                            data: $(this).serialize(),
                            success: function (result)
                            {
                                
                                $("#throbber").hide();
                                if (result.Success)
                                {
                                    $.redirect('@Url.Action("Complete")');
                                } else
                                {
                                    $(".validation-summary-errors").append("<p>" + result.Message + "</p>");
                                    $(".validation-summary-errors").show();
                                }
                            },
                            error: function (jqXhr)
                            {
                                $("#throbber").hide();
                                VirtoCommerce.extractErrors(jqXhr, validator);
                            }
                        });
                    }
                    return false;
                });
            });

        });
    </script>
</head>
<body>
    <div id="header">
        <div id="branding">
            <h1>Virto Commerce</h1>
        </div>
    </div>
    <div id="main">
        <div class="zone zone-content">
            <h1>Get Started</h1>

            <div>
                @using (Html.BeginForm("Index", "Install", new { area = "VirtoAdmin" }, FormMethod.Post))
                {
                    <h2>Database setup</h2>
                    <div id="inprogress" />
                        
                    <div class="message-Information" style="display: none;">
                    </div>

                    <div class="validation-summary-errors" style="display: none;">
                    </div>
                        
                    <fieldset class="data">
                        @if (Model.DbAdminRequired)
                        {
                            @Html.HiddenFor(m => m.DbAdminRequired)
                            <div>
                                @Html.LabelFor(m => m.DbAdminUser)
                                @Html.TextBoxFor(m => m.DbAdminUser)
                                @Html.Label(Resource.DbAdminUserTip, new { @class = "hint" })
                                @Html.ValidationMessageFor(m => m.DbAdminUser)
                            </div>
                            <div>
                                @Html.LabelFor(m => m.DbAdminPassword)
                                @Html.PasswordFor(m => m.DbAdminPassword)
                                @Html.Label(Resource.DbAdminPasswordTip, new { @class = "hint" })
                                @Html.ValidationMessageFor(m => m.DbAdminPassword)
                            </div>
                        }
                        <div>
                            @Html.LabelFor(m => m.DataSource)
                            @Html.TextBoxFor(m => m.DataSource)
                            @Html.Label(Resource.DataSourceTip, new { @class = "hint" })
                            @Html.ValidationMessageFor(m => m.DataSource)
                        </div>
                        <div>
                            @Html.LabelFor(m => m.InitialCatalog)
                            @Html.TextBoxFor(m => m.InitialCatalog)
                            @Html.Label(Resource.InitialCatalogTip, new { @class = "hint" })
                            @Html.ValidationMessageFor(m => m.InitialCatalog)
                        </div>
                        <div>
                            @Html.LabelFor(m => m.DbUserName)
                            @Html.TextBoxFor(m => m.DbUserName)
                            @Html.Label(Resource.DbUserNameTip, new { @class = "hint" })
                            @Html.ValidationMessageFor(m => m.DbUserName)
                        </div>
                        <div>
                            @Html.LabelFor(m => m.DbUserPassword)
                            @Html.PasswordFor(m => m.DbUserPassword, new { value = Model.DbUserPassword })
                            @Html.Label(Resource.DbUserPasswordTip, new { @class = "hint" })
                            @Html.ValidationMessageFor(m => m.DbUserPassword)
                        </div>
                        <div>
                            @Html.LabelFor(m => m.SetupSampleData)
                            <input id="SetupSampleData" name="SetupSampleData" 
                                   type="checkbox" value="@Model.SetupSampleData.ToString()"
                                @(Model.SetupSampleData ? "checked=checked" : string.Empty)>
                        </div>
                        <div>
                            <button name="SubmitButton" type="submit" value="CreateDb">@Resource.SetupDatabase</button>
                        </div>
                    </fieldset>
                }
            </div>
        </div>
    </div>
    <div class="console">
    </div>
    <div id="throbber">
        <div class="curtain"></div>
        <div class="curtain-content">
            <div>
                <h1 id="setUpHeader">@Resource.LongProcessMessage</h1>
                <p>
                    <img src="@Href("../../content/images/inprogress.gif")" alt="" />
                </p>
            </div>
        </div>
    </div>
</body>
</html>
